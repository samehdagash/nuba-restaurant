<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>🔐 אבטחה חכמה - Nuba Restaurant</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #000 0%, #1a1a1a 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(212, 175, 55, 0.05);
            border: 2px solid #d4af37;
            border-radius: 20px;
            padding: 40px;
        }

        h1 {
            color: #d4af37;
            text-align: center;
            font-size: 36px;
            margin-bottom: 30px;
        }

        .section {
            background: rgba(0, 0, 0, 0.5);
            border-right: 4px solid #d4af37;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
        }

        h2 {
            color: #d4af37;
            margin-bottom: 20px;
            font-size: 24px;
        }

        input {
            width: 100%;
            padding: 15px;
            margin: 10px 0;
            background: rgba(0, 0, 0, 0.7);
            border: 1px solid #d4af37;
            color: #fff;
            border-radius: 8px;
            font-size: 16px;
        }

        button {
            background: linear-gradient(135deg, #d4af37 0%, #b8941f 100%);
            color: #000;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            font-weight: bold;
            border-radius: 30px;
            cursor: pointer;
            width: 100%;
            margin: 10px 0;
            transition: all 0.3s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(212, 175, 55, 0.4);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 15px 0;
            display: none;
        }

        .status.show {
            display: block;
        }

        .success {
            background: rgba(76, 175, 80, 0.2);
            border: 1px solid #4caf50;
            color: #4caf50;
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid #f44336;
            color: #f44336;
        }

        .info {
            background: rgba(33, 150, 243, 0.2);
            border: 1px solid #2196f3;
            color: #2196f3;
        }

        .warning {
            background: rgba(255, 152, 0, 0.2);
            border: 1px solid #ff9800;
            color: #ff9800;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .method-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }

        .method-card {
            background: rgba(0, 0, 0, 0.7);
            border: 2px solid #d4af37;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .method-card:hover {
            background: rgba(212, 175, 55, 0.1);
            transform: translateY(-5px);
        }

        .method-card.selected {
            background: rgba(212, 175, 55, 0.2);
            border-color: #ffd700;
        }

        .method-icon {
            font-size: 48px;
            margin-bottom: 10px;
        }

        .method-title {
            font-size: 18px;
            color: #d4af37;
            margin-bottom: 10px;
        }

        .method-desc {
            font-size: 14px;
            color: #ccc;
        }

        .code-display {
            background: #000;
            border: 2px solid #d4af37;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 32px;
            font-family: monospace;
            letter-spacing: 5px;
            color: #d4af37;
            margin: 20px 0;
        }

        .qr-code {
            background: white;
            padding: 20px;
            border-radius: 10px;
            display: inline-block;
            margin: 20px auto;
        }

        .copy-button {
            background: #4caf50;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            font-size: 14px;
            margin-left: 10px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 אבטחה חכמה למערכת הניהול</h1>

        <div class="warning">
            <h3>📱 המלצה: השתמש באפליקציית אימות</h3>
            <p>השיטה הכי בטוחה ונוחה - עובדת מכל מכשיר, בכל מקום!</p>
        </div>

        <!-- בחירת שיטת אבטחה -->
        <div class="section">
            <h2>בחר שיטת אבטחה</h2>
            <div class="method-grid">
                <div class="method-card" onclick="selectMethod('authenticator')" id="method-authenticator">
                    <div class="method-icon">📱</div>
                    <div class="method-title">אפליקציית אימות</div>
                    <div class="method-desc">Google/Microsoft Authenticator - הכי מומלץ!</div>
                </div>
                <div class="method-card" onclick="selectMethod('sms')" id="method-sms">
                    <div class="method-icon">💬</div>
                    <div class="method-title">SMS לטלפון</div>
                    <div class="method-desc">קבל קוד ב-SMS לנייד</div>
                </div>
                <div class="method-card" onclick="selectMethod('email')" id="method-email">
                    <div class="method-icon">📧</div>
                    <div class="method-title">קוד למייל</div>
                    <div class="method-desc">קבל קוד לאימייל</div>
                </div>
                <div class="method-card" onclick="selectMethod('pin')" id="method-pin">
                    <div class="method-icon">🔢</div>
                    <div class="method-title">PIN נוסף</div>
                    <div class="method-desc">סיסמה + קוד PIN</div>
                </div>
            </div>
        </div>

        <!-- הגדרת אפליקציית אימות -->
        <div class="section" id="authenticator-setup" style="display: none;">
            <h2>📱 הגדרת אפליקציית אימות</h2>
            <ol style="text-align: right; padding-right: 20px;">
                <li>הורד את האפליקציה:
                    <br>• Google Authenticator
                    <br>• Microsoft Authenticator
                    <br>• Authy
                </li>
                <li>סרוק את הקוד QR:</li>
            </ol>
            <div style="text-align: center;">
                <div id="qrcode" class="qr-code"></div>
            </div>
            <p>או הכנס את הקוד הסודי ידנית:</p>
            <div class="code-display" id="secretCode">NUBA-XXXX-XXXX</div>
            <button onclick="setupAuthenticator()">אשר הגדרה</button>
            <div id="authStatus" class="status"></div>
        </div>

        <!-- הגדרת SMS -->
        <div class="section" id="sms-setup" style="display: none;">
            <h2>💬 הגדרת אימות SMS</h2>
            <input type="tel" id="phoneNumber" placeholder="מספר טלפון (05X-XXXXXXX)">
            <button onclick="setupSMS()">שלח קוד אימות</button>
            <input type="text" id="smsCode" placeholder="הכנס קוד שקיבלת" style="display: none;">
            <button id="verifySMSBtn" onclick="verifySMS()" style="display: none;">אמת קוד</button>
            <div id="smsStatus" class="status"></div>
        </div>

        <!-- הגדרת Email -->
        <div class="section" id="email-setup" style="display: none;">
            <h2>📧 הגדרת אימות אימייל</h2>
            <input type="email" id="emailAddress" placeholder="כתובת אימייל">
            <button onclick="setupEmail()">שלח קוד אימות</button>
            <input type="text" id="emailCode" placeholder="הכנס קוד שקיבלת" style="display: none;">
            <button id="verifyEmailBtn" onclick="verifyEmail()" style="display: none;">אמת קוד</button>
            <div id="emailStatus" class="status"></div>
        </div>

        <!-- הגדרת PIN -->
        <div class="section" id="pin-setup" style="display: none;">
            <h2>🔢 הגדרת קוד PIN</h2>
            <p>קוד PIN נוסף של 6 ספרות שיידרש יחד עם הסיסמה</p>
            <input type="password" id="pinCode" placeholder="הכנס PIN (6 ספרות)" maxlength="6" pattern="[0-9]{6}">
            <input type="password" id="confirmPin" placeholder="אמת PIN" maxlength="6" pattern="[0-9]{6}">
            <button onclick="setupPIN()">הגדר PIN</button>
            <div id="pinStatus" class="status"></div>
        </div>

        <!-- שינוי סיסמה ראשית -->
        <div class="section">
            <h2>🔑 שינוי סיסמה ראשית</h2>
            <input type="password" id="currentPassword" placeholder="סיסמה נוכחית">
            <input type="password" id="newPassword" placeholder="סיסמה חדשה (מינימום 10 תווים)">
            <input type="password" id="confirmPassword" placeholder="אימות סיסמה חדשה">
            <button onclick="changePassword()">שנה סיסמה</button>
            <div id="passwordStatus" class="status"></div>
        </div>

        <!-- הגדרות נוספות -->
        <div class="section">
            <h2>⚙️ הגדרות נוספות</h2>
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="rememberDevice" checked>
                    זכור מכשיר זה ל-30 יום (לא תצטרך קוד בכל כניסה)
                </label>
            </div>
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="notifyLogin" checked>
                    שלח התראה על כל כניסה למערכת
                </label>
            </div>
            <div style="margin: 15px 0;">
                <label>
                    <input type="checkbox" id="autoLogout" checked>
                    התנתק אוטומטית אחרי 30 דקות של חוסר פעילות
                </label>
            </div>
            <button onclick="saveSettings()">שמור הגדרות</button>
            <div id="settingsStatus" class="status"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-auth-compat.js"></script>
    <!-- QR Code Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyC8CoiOsMhq7Zn3iDrfSHfdzHvEZKGZ-Tk",
            authDomain: "nuba-restaurant.firebaseapp.com",
            projectId: "nuba-restaurant",
            storageBucket: "nuba-restaurant.firebasestorage.app",
            messagingSenderId: "1084628930920",
            appId: "1:1084628930920:web:68f29b63b0bd65ccc406dd"
        };

        let db, auth;
        let selectedMethod = null;

        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
            db = firebase.firestore();
            auth = firebase.auth();
        } catch (error) {
            console.error('Firebase error:', error);
        }

        function selectMethod(method) {
            // Hide all setup sections
            document.querySelectorAll('[id$="-setup"]').forEach(el => {
                el.style.display = 'none';
            });

            // Remove selected class from all cards
            document.querySelectorAll('.method-card').forEach(el => {
                el.classList.remove('selected');
            });

            // Show selected setup and mark card
            document.getElementById(`${method}-setup`).style.display = 'block';
            document.getElementById(`method-${method}`).classList.add('selected');

            selectedMethod = method;

            // Generate QR code for authenticator
            if (method === 'authenticator') {
                generateQRCode();
            }
        }

        function generateQRCode() {
            const secret = generateSecret();
            const otpauth = `otpauth://totp/Nuba%20Restaurant:admin?secret=${secret}&issuer=Nuba`;

            // Clear previous QR code
            document.getElementById('qrcode').innerHTML = '';

            // Generate new QR code
            new QRCode(document.getElementById('qrcode'), {
                text: otpauth,
                width: 200,
                height: 200
            });

            // Display secret
            document.getElementById('secretCode').textContent = formatSecret(secret);

            // Save secret to Firebase
            saveSecretToFirebase(secret);
        }

        function generateSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 16; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        function formatSecret(secret) {
            return secret.match(/.{1,4}/g).join('-');
        }

        async function saveSecretToFirebase(secret) {
            try {
                await db.collection('settings').doc('twoFactor').set({
                    secret: secret,
                    method: 'authenticator',
                    enabled: true,
                    created: new Date().toISOString()
                });
            } catch (error) {
                console.error('Save error:', error);
            }
        }

        async function setupAuthenticator() {
            showStatus('authStatus', '✅ אפליקציית האימות הוגדרה בהצלחה!', 'success');

            await db.collection('settings').doc('security').update({
                twoFactorEnabled: true,
                twoFactorMethod: 'authenticator'
            });
        }

        async function setupSMS() {
            const phone = document.getElementById('phoneNumber').value;

            if (!phone || !/^05\d{8}$/.test(phone)) {
                showStatus('smsStatus', 'מספר טלפון לא תקין', 'error');
                return;
            }

            // Generate 6-digit code
            const code = Math.floor(100000 + Math.random() * 900000).toString();

            // Save to Firebase
            await db.collection('settings').doc('twoFactor').set({
                phone: phone,
                code: code,
                method: 'sms',
                created: new Date().toISOString()
            });

            // Show verification field
            document.getElementById('smsCode').style.display = 'block';
            document.getElementById('verifySMSBtn').style.display = 'block';

            showStatus('smsStatus', `קוד נשלח ל-${phone} (לצורך דוגמה: ${code})`, 'info');
        }

        async function verifySMS() {
            const code = document.getElementById('smsCode').value;

            // Verify code from Firebase
            const doc = await db.collection('settings').doc('twoFactor').get();
            if (doc.exists && doc.data().code === code) {
                showStatus('smsStatus', '✅ הטלפון אומת בהצלחה!', 'success');

                await db.collection('settings').doc('security').update({
                    twoFactorEnabled: true,
                    twoFactorMethod: 'sms',
                    phone: doc.data().phone
                });
            } else {
                showStatus('smsStatus', 'קוד שגוי', 'error');
            }
        }

        async function setupEmail() {
            const email = document.getElementById('emailAddress').value;

            if (!email || !email.includes('@')) {
                showStatus('emailStatus', 'כתובת אימייל לא תקינה', 'error');
                return;
            }

            // Generate 6-digit code
            const code = Math.floor(100000 + Math.random() * 900000).toString();

            // Save to Firebase
            await db.collection('settings').doc('twoFactor').set({
                email: email,
                code: code,
                method: 'email',
                created: new Date().toISOString()
            });

            // Show verification field
            document.getElementById('emailCode').style.display = 'block';
            document.getElementById('verifyEmailBtn').style.display = 'block';

            showStatus('emailStatus', `קוד נשלח ל-${email} (לצורך דוגמה: ${code})`, 'info');
        }

        async function verifyEmail() {
            const code = document.getElementById('emailCode').value;

            // Verify code from Firebase
            const doc = await db.collection('settings').doc('twoFactor').get();
            if (doc.exists && doc.data().code === code) {
                showStatus('emailStatus', '✅ האימייל אומת בהצלחה!', 'success');

                await db.collection('settings').doc('security').update({
                    twoFactorEnabled: true,
                    twoFactorMethod: 'email',
                    email: doc.data().email
                });
            } else {
                showStatus('emailStatus', 'קוד שגוי', 'error');
            }
        }

        async function setupPIN() {
            const pin = document.getElementById('pinCode').value;
            const confirmPin = document.getElementById('confirmPin').value;

            if (!pin || pin.length !== 6 || !/^\d{6}$/.test(pin)) {
                showStatus('pinStatus', 'PIN חייב להיות 6 ספרות', 'error');
                return;
            }

            if (pin !== confirmPin) {
                showStatus('pinStatus', 'קודי PIN לא תואמים', 'error');
                return;
            }

            // Hash PIN
            const hashedPin = await hashPassword(pin);

            await db.collection('settings').doc('security').update({
                twoFactorEnabled: true,
                twoFactorMethod: 'pin',
                pinHash: hashedPin
            });

            showStatus('pinStatus', '✅ קוד PIN הוגדר בהצלחה!', 'success');

            // Clear fields
            document.getElementById('pinCode').value = '';
            document.getElementById('confirmPin').value = '';
        }

        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                showStatus('passwordStatus', 'מלא את כל השדות', 'error');
                return;
            }

            if (newPassword.length < 10) {
                showStatus('passwordStatus', 'הסיסמה חייבת להכיל לפחות 10 תווים', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showStatus('passwordStatus', 'הסיסמאות לא תואמות', 'error');
                return;
            }

            // Must contain uppercase, lowercase, numbers and special chars
            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{10,}$/;
            if (!passwordRegex.test(newPassword)) {
                showStatus('passwordStatus', 'הסיסמה חייבת להכיל אותיות גדולות, קטנות, מספרים ותו מיוחד', 'error');
                return;
            }

            try {
                const hashedPassword = await hashPassword(newPassword);

                await db.collection('settings').doc('security').set({
                    adminPassword: hashedPassword,
                    passwordUpdated: new Date().toISOString(),
                    requirePasswordChange: false
                }, { merge: true });

                showStatus('passwordStatus', '✅ הסיסמה שונתה בהצלחה!', 'success');

                // Clear fields
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

            } catch (error) {
                showStatus('passwordStatus', 'שגיאה: ' + error.message, 'error');
            }
        }

        async function saveSettings() {
            const settings = {
                rememberDevice: document.getElementById('rememberDevice').checked,
                notifyLogin: document.getElementById('notifyLogin').checked,
                autoLogout: document.getElementById('autoLogout').checked,
                rememberDays: 30,
                autoLogoutMinutes: 30,
                updated: new Date().toISOString()
            };

            await db.collection('settings').doc('preferences').set(settings);
            showStatus('settingsStatus', '✅ הגדרות נשמרו!', 'success');
        }

        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'nuba-salt-2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        function showStatus(elementId, message, type) {
            const element = document.getElementById(elementId);
            element.className = `status show ${type}`;
            element.innerHTML = message;
        }

        // Initialize on load
        window.addEventListener('DOMContentLoaded', () => {
            // Auto-select authenticator method as recommended
            selectMethod('authenticator');
        });
    </script>
</body>
</html>